<!DOCTYPE html>
<html lang="pt-BR">

<head>
     
  <meta charset="UTF-8">
      <title>Balança Comercial do Brasil</title>
     
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
      <style>
    body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background-color: #f4f4f4;
    }

    #main {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #map-chart {
      width: 90%;
      height: 60%;
    }

    #line-chart {
      width: 90%;
      height: 40%;
    }

    #filtro-container {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1000;
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }
  </style>
</head>

<body>
      <div id="main">
            <div id="map-chart"></div>
            <div id="line-chart"></div>
        </div>

      <div id="filtro-container">
            <label for="select-tipo">Mostrar:</label>
            <select id="select-tipo">
                  <option value="BAL" selected>Balança Comercial</option>
                  <option value="EXP">Exportações</option>
                  <option value="IMP">Importações</option>
              </select>
        </div>


     
  <script>
    const myLineChart = echarts.init(document.getElementById('line-chart'));
    const myMapChart = echarts.init(document.getElementById('map-chart'));
    const selectTipo = document.getElementById('select-tipo');

    myLineChart.showLoading();
    myMapChart.showLoading();

    Promise.all([
      fetch("world.json"),
      fetch("BR-exportacoes_importacoes_2025.json")
    ])
      .then(responses => Promise.all(responses.map(res => res.json())))
      .then(([worldJson, tradeData]) => {
        myLineChart.hideLoading();
        myMapChart.hideLoading();
        echarts.registerMap('world', worldJson);

        let anoAtual;

        function formatarValor(valor) {
          if (isNaN(valor) || valor === null) return 'Sem dados';
          const umBilhao = 1_000_000_000;
          const umMilhao = 1_000_000;
          let sufixo = '';
          let valorFinal = valor;
          if (Math.abs(valor) >= umBilhao) {
            valorFinal = valor / umBilhao;
            sufixo = ' bi';
          } else if (Math.abs(valor) >= umMilhao) {
            valorFinal = valor / umMilhao;
            sufixo = ' mi';
          }
          return `US$ ${valorFinal.toFixed(1).replace('.', ',')}${sufixo}`;
        }

        const years = Object.keys(tradeData.BAL).map(a => parseInt(a)).sort((a, b) => a - b);
        const lineChartData = ['EXP', 'IMP', 'BAL'].map(type => {
          return {
            name: type,
            type: 'line',
            data: years.map(year => {
              const yearData = tradeData[type][year];
              const totalValue = yearData.reduce((sum, current) => sum + current.us_value, 0);
              return totalValue;
            })
          };
        });

        const lineOption = {
          tooltip: {
            trigger: 'axis',
            formatter: function (params) {
              let result = params[0].name + '<br/>';
              params.forEach(item => {
                result += `<span style="display:inline-block;margin-right:4px;border-radius:10px;width:10px;height:10px;background-color:${item.color};"></span>` +
                  item.seriesName + ': <strong>' + formatarValor(item.value) + '</strong><br/>';
              });
              return result;
            }
          },
          legend: {
            data: ['EXP', 'IMP', 'BAL'],
            top: 'top'
          },
          xAxis: {
            type: 'category',
            data: years
          },
          yAxis: {
            type: 'value',
            axisLabel: {
              formatter: function (value) {
                const valorEmBilhoes = value / 1_000_000_000;
                return `${valorEmBilhoes.toFixed(0)} bi`;
              }
            }
          },
          series: lineChartData,
          dataZoom: [{ // NOVO: Adiciona a barra de filtro de anos
            type: 'slider',
            xAxisIndex: 0,
            start: 0,
            end: 100,
            bottom: '10px'
          }]
        };

        myLineChart.setOption(lineOption);

        function updateMap(tipo, ano) {
          const dataAno = tradeData[tipo][ano];
          const mapData = dataAno.map(d => ({
            name: d.name,
            value: d.us_value
          }));

          const values = mapData.map(item => item.value).filter(v => v !== null && !isNaN(v));
          const maxVal = values.length > 0 ? Math.max(...values) : 0;
          const minVal = values.length > 0 ? Math.min(...values) : 0;

          const option = {
            title: [{
              text: `${tipo === "EXP" ? "Exportações" : tipo === "IMP" ? "Importações" : "Balança Comercial"} por País (${ano})`,
              subtext: 'Dados do Monitor do Comércio Exterior Brasileiro',
              left: 'center',
              top: '0'
            }],
            graphic: [{
              type: 'text',
              right: '9%',
              top: '5%',
              style: {
                text: 'Volume negociado com o país (Bilhões de US$)',
                font: '14px sans-serif',
                fill: '#333'
              },
              rotation: -Math.PI / 2
            }],
            tooltip: {
              trigger: 'item',
              formatter: function (params) {
                if (params.seriesType === 'map' && params.value != null) {
                  return `${params.name}<br/> <strong>${formatarValor(params.value)}</strong>`;
                }
                return `${params.name}: Sem dados`;
              }
            },
            visualMap: {
              right: '10%',
              top: '5%',
              bottom: '5%',
              height: 200,
              min: tipo === "BAL" ? Math.min(minVal, 0) : 0,
              max: tipo === "BAL" ? Math.max(maxVal, 0) : maxVal,
              inRange: {
                color: tipo === "BAL" ?
                  ['#d73027', '#fee090', '#1a9850'] :
                  ['#c7e9c0', '#00441b']
              },
              text: ['Maior', 'Menor'],
              calculable: true,
              orient: 'vertical'
            },
            geo: {
              map: 'world',
              roam: true,
              itemStyle: {
                areaColor: '#e0e0e0',
                borderColor: '#b0b0b0'
              },
              emphasis: {
                itemStyle: {
                  areaColor: '#ffc107',
                  borderColor: '#777'
                },
                label: {
                  show: true
                }
              }
            },
            series: [{
              type: 'map',
              geoIndex: 0,
              data: mapData
            }]
          };

          myMapChart.setOption(option, true);
        }

        const latestYear = years[years.length - 1];
        updateMap('BAL', latestYear);

        myLineChart.on('click', function (params) {
          if (params.seriesType === 'line' && params.dataIndex !== undefined) {
            const clickedType = params.seriesName;
            const clickedYear = years[params.dataIndex];
            updateMap(clickedType, clickedYear);
          }
        });
      })
      .catch(error => {
        myLineChart.hideLoading();
        myMapChart.hideLoading();
        console.error("Erro ao carregar os dados:", error);
      });

    window.onresize = () => {
      myLineChart.resize();
      myMapChart.resize();
    };
  </script>
</body>

</html>
